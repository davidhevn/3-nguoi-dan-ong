<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Snake Online Multiplayer</title>
  <style>
    /* Giữ nguyên CSS cũ hoặc tùy chỉnh thêm */
    body { margin: 0; background: #0a0a0a; overflow: hidden; color: white; font-family: sans-serif; }
    canvas { display: block; }
    .ui { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; }
    button { padding: 15px 30px; font-size: 1.2rem; cursor: pointer; background: #00ff88; border: none; border-radius: 5px; }
    input { padding: 10px; font-size: 1.1rem; margin-bottom: 10px; }
  </style>
</head>
<body>

<canvas id="gameCanvas"></canvas>

<div id="startScreen" class="ui">
  <h1>SNAKE ONLINE (PYTHON SERVER)</h1>
  <input type="text" id="username" placeholder="Nhập tên..." value="Player1">
  <br>
  <button onclick="joinGame()">THAM GIA</button>
  <p style="color: #888; font-size: 0.9rem">Đảm bảo chạy server.py trước!</p>
</div>

<script>
  const canvas = document.getElementById('gameCanvas');
  const ctx = canvas.getContext('2d');
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;

  // --- CẤU HÌNH ---
  const WEBSOCKET_URL = "ws://localhost:8765"; 
  
  // --- TRẠNG THÁI GAME ---
  let socket;
  let myId = null; // Server không cần gửi ID về, ta tự quản lý qua kết nối, nhưng client cần biết ID của địch
  let isPlaying = false;
  
  let mySnake = { x: 500, y: 500, angle: 0, body: [], name: "", skin: "#00ff88" };
  let otherSnakes = {}; // Lưu đối thủ: { "user_1234": {x, y, body...} }
  
  let mouse = { x: 0, y: 0 };

  // --- KẾT NỐI SOCKET ---
  function joinGame() {
    const name = document.getElementById('username').value;
    mySnake.name = name;

    socket = new WebSocket(WEBSOCKET_URL);

    socket.onopen = () => {
      console.log("Đã kết nối tới Server Python!");
      document.getElementById('startScreen').style.display = 'none';
      isPlaying = true;
      initMySnake();
      loop();
    };

    socket.onmessage = (event) => {
      const msg = JSON.parse(event.data);
      if (msg.type === "update") {
        // Nhận dữ liệu toàn bộ server: { "user_123": {...}, "user_456": {...} }
        updateWorldState(msg.data);
      }
    };

    socket.onclose = () => {
      alert("Mất kết nối với Server!");
      location.reload();
    };
  }

  function initMySnake() {
    mySnake.x = Math.random() * 1000;
    mySnake.y = Math.random() * 1000;
    mySnake.body = [];
    for(let i=0; i<20; i++) mySnake.body.push({x: mySnake.x, y: mySnake.y});
  }

  function updateWorldState(serverData) {
    // serverData chứa tất cả player. Ta cần lọc ra đâu là mình, đâu là địch.
    // Tuy nhiên, ở bản đơn giản này, server không báo "bạn là ID nào".
    // Mẹo: Server code ở trên dùng ID random.
    // Để đơn giản, client sẽ vẽ TẤT CẢ dữ liệu nhận được từ server trừ chính mình
    // (Trong thực tế, server nên gửi gói tin "Welcome" chứa ID của bạn lúc connect).
    
    otherSnakes = serverData; 
  }

  // --- LOGIC GAME ---
  window.addEventListener('mousemove', e => {
    mouse.x = e.clientX;
    mouse.y = e.clientY;
  });

  function loop() {
    if (!isPlaying) return;
    requestAnimationFrame(loop);

    ctx.fillStyle = '#111';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // 1. Di chuyển bản thân
    const dx = mouse.x - canvas.width/2; // Camera lock giữa màn hình
    const dy = mouse.y - canvas.height/2;
    const angle = Math.atan2(dy, dx);
    
    const speed = 5;
    mySnake.x += Math.cos(angle) * speed;
    mySnake.y += Math.sin(angle) * speed;
    
    // Update thân
    mySnake.body.unshift({x: mySnake.x, y: mySnake.y});
    if(mySnake.body.length > 50) mySnake.body.pop();

    // 2. Gửi dữ liệu lên Server
    if (socket.readyState === WebSocket.OPEN) {
      const packet = {
        type: "move",
        info: {
          x: mySnake.x,
          y: mySnake.y,
          body: mySnake.body.filter((_, i) => i % 2 === 0), // Gửi ít điểm hơn để giảm lag
          name: mySnake.name,
          color: mySnake.skin
        }
      };
      socket.send(JSON.stringify(packet));
    }

    // 3. Vẽ Camera (Giả lập camera đi theo mình)
    ctx.save();
    ctx.translate(canvas.width/2 - mySnake.x, canvas.height/2 - mySnake.y);

    // Vẽ Lưới nền
    drawGrid();

    // Vẽ Đối thủ (Từ dữ liệu Server)
    for (const [id, data] of Object.entries(otherSnakes)) {
        // Đây là điểm yếu của bản demo này: ta sẽ thấy bóng ma của chính mình do server gửi lại.
        // Để khắc phục triệt để cần logic ID (xem phần lưu ý bên dưới).
        // Tạm thời ta cứ vẽ hết để test kết nối.
        drawSnake(data); 
    }
    
    // Vẽ Chính mình (đè lên để mượt hơn, không chờ server)
    // drawSnake(mySnake); // Nếu vẽ cái này sẽ bị trùng với server trả về

    ctx.restore();
  }

  function drawSnake(s) {
    if (!s.body) return;
    ctx.fillStyle = s.color || '#fff';
    
    // Vẽ thân
    for(let p of s.body) {
      ctx.beginPath(); ctx.arc(p.x, p.y, 10, 0, Math.PI*2); ctx.fill();
    }
    // Vẽ đầu
    ctx.fillStyle = '#fff';
    ctx.beginPath(); ctx.arc(s.x, s.y, 12, 0, Math.PI*2); ctx.fill();
    
    // Tên
    ctx.fillStyle = "white";
    ctx.font = "12px Arial";
    ctx.textAlign = "center";
    ctx.fillText(s.name || "Unknown", s.x, s.y - 20);
  }

  function drawGrid() {
    ctx.strokeStyle = '#222';
    ctx.lineWidth = 2;
    const gridSize = 100;
    // Vẽ lưới đơn giản vùng rộng
    for(let x=-2000; x<2000; x+=gridSize) {
       ctx.beginPath(); ctx.moveTo(x, -2000); ctx.lineTo(x, 2000); ctx.stroke();
    }
    for(let y=-2000; y<2000; y+=gridSize) {
       ctx.beginPath(); ctx.moveTo(-2000, y); ctx.lineTo(2000, y); ctx.stroke();
    }
  }

</script>
</body>
</html>
