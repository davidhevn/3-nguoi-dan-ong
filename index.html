<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Snake Battle Royale</title>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet">
  <style>
    body { margin: 0; background: #050505; overflow: hidden; color: white; font-family: 'Segoe UI', sans-serif; }
    canvas { display: block; }
    
    /* UI Overlay */
    .ui { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; justify-content: center; align-items: center; }
    .panel { background: rgba(0,0,0,0.85); padding: 40px; border-radius: 20px; text-align: center; pointer-events: auto; backdrop-filter: blur(10px); border: 1px solid #333; }
    h1 { font-family: 'Fredoka One'; color: #00ff88; font-size: 3rem; margin: 0 0 20px 0; text-shadow: 0 0 20px #00ff88; }
    input { padding: 15px; font-size: 1.2rem; border-radius: 10px; border: none; text-align: center; width: 80%; margin-bottom: 20px; }
    button { padding: 15px 40px; font-size: 1.2rem; background: linear-gradient(45deg, #00ff88, #00ccff); border: none; border-radius: 50px; font-weight: bold; cursor: pointer; transition: 0.2s; }
    button:hover { transform: scale(1.1); box-shadow: 0 0 30px #00ff88; }
    
    /* HUD */
    .hud { position: absolute; top: 20px; left: 20px; font-size: 1.5rem; font-weight: bold; text-shadow: 2px 2px 0 #000; }
    .kill-feed { position: absolute; top: 20px; right: 20px; text-align: right; font-size: 0.9rem; color: #ff4d4d; }
  </style>
</head>
<body>

<canvas id="gameCanvas"></canvas>

<div class="hud">SCORE: <span id="scoreVal" style="color:#00ff88">0</span></div>

<div class="ui" id="uiLayer">
  <div class="panel" id="startPanel">
    <h1>SNAKE BATTLE</h1>
    <input type="text" id="nickname" placeholder="Nhập tên chiến binh..." value="Guest">
    <br>
    <button onclick="joinGame()">VÀO CHIẾN TRƯỜNG</button>
  </div>
  
  <div class="panel" id="deathPanel" style="display:none">
    <h1 style="color: #ff4d4d">BẠN ĐÃ CHẾT!</h1>
    <p>Điểm số: <span id="finalScore">0</span></p>
    <button onclick="location.reload()">CHƠI LẠI</button>
  </div>
</div>

<script>
  /* --- CẤU HÌNH --- */
  const CONFIG = {
    server: "ws://localhost:8765", // Sửa thành IP của bạn nếu chơi LAN
    worldSize: 2000
  };

  const canvas = document.getElementById('gameCanvas');
  const ctx = canvas.getContext('2d');
  let socket;
  
  // State
  let isPlaying = false;
  let myId = "me_" + Math.floor(Math.random()*99999);
  let mySnake = { x: 500, y: 500, angle: 0, body: [], score: 0, name: "", skin: "#00ff88" };
  let others = {}; // {id: snakeData}
  let foods = {};  // {id: foodData}
  
  let camera = { x: 0, y: 0 };
  let mouse = { x: 0, y: 0 };

  // Init Canvas
  function resize(){ canvas.width=window.innerWidth; canvas.height=window.innerHeight; }
  window.addEventListener('resize', resize); resize();
  window.addEventListener('mousemove', e => { mouse.x = e.clientX; mouse.y = e.clientY; });

  /* --- LOGIC MẠNG --- */
  function connect() {
    socket = new WebSocket(CONFIG.server);
    
    socket.onopen = () => console.log("Connected!");
    
    socket.onmessage = (e) => {
      const msg = JSON.parse(e.data);
      
      // 1. Cập nhật vị trí người chơi khác
      if (msg.type === "player_update") {
        others = msg.data;
      } 
      // 2. Cập nhật thức ăn
      else if (msg.type === "food_update") {
        foods = msg.data;
      }
    };

    socket.onclose = () => { if(isPlaying) alert("Mất kết nối Server!"); };
  }
  connect();

  /* --- GAME LOOP --- */
  function joinGame() {
    const name = document.getElementById('nickname').value || "Guest";
    mySnake.name = name;
    // Random vị trí spawn
    mySnake.x = Math.random() * CONFIG.worldSize;
    mySnake.y = Math.random() * CONFIG.worldSize;
    // Random màu
    mySnake.skin = `hsl(${Math.random()*360}, 100%, 50%)`;
    
    // Init body
    mySnake.body = [];
    for(let i=0; i<10; i++) mySnake.body.push({x: mySnake.x, y: mySnake.y});

    document.getElementById('startPanel').style.display = 'none';
    isPlaying = true;
    loop();
  }

  function loop() {
    if(!isPlaying) return;
    requestAnimationFrame(loop);

    updateMySnake();
    checkCollisions();
    sendUpdate();
    render();
  }

  /* --- LOGIC VẬT LÝ & VA CHẠM (QUAN TRỌNG) --- */
  function updateMySnake() {
    // 1. Tính góc
    const dx = mouse.x - window.innerWidth/2;
    const dy = mouse.y - window.innerHeight/2;
    mySnake.angle = Math.atan2(dy, dx);

    // 2. Di chuyển
    const speed = 5 + (mySnake.score / 500); // Càng to càng nhanh một chút
    mySnake.x += Math.cos(mySnake.angle) * speed;
    mySnake.y += Math.sin(mySnake.angle) * speed;

    // 3. Kéo thân
    mySnake.body.unshift({x: mySnake.x, y: mySnake.y});
    // Độ dài = cơ bản + điểm số
    const targetLen = 10 + Math.floor(mySnake.score / 10);
    while(mySnake.body.length > targetLen) mySnake.body.pop();

    // 4. Camera
    camera.x += (mySnake.x - window.innerWidth/2 - camera.x) * 0.1;
    camera.y += (mySnake.y - window.innerHeight/2 - camera.y) * 0.1;
  }

  function checkCollisions() {
    // 1. Ăn Mồi (Client check -> Gửi Server xóa)
    for (let fid in foods) {
      const f = foods[fid];
      const dist = Math.hypot(mySnake.x - f.x, mySnake.y - f.y);
      // Bán kính ăn: 20px
      if (dist < 30) {
        mySnake.score += f.val;
        document.getElementById('scoreVal').innerText = mySnake.score;
        // Gửi yêu cầu ăn
        socket.send(JSON.stringify({ type: "eat", food_id: f.id }));
        // Xóa tạm ở client cho mượt (Server sẽ sync lại sau)
        delete foods[fid]; 
      }
    }

    // 2. Đâm vào Tường
    if (mySnake.x < 0 || mySnake.x > CONFIG.worldSize || mySnake.y < 0 || mySnake.y > CONFIG.worldSize) {
      die();
    }

    // 3. Đâm vào Rắn khác (Battle Royale)
    for (let pid in others) {
      const enemy = others[pid];
      if (enemy.id === myId) continue; // Bỏ qua bản thân (nếu server gửi về)
      if (!enemy.body) continue;

      // Duyệt qua từng đốt thân của địch
      for (let i = 0; i < enemy.body.length; i += 2) { // Check nhảy cóc để tối ưu
        const part = enemy.body[i];
        const dist = Math.hypot(mySnake.x - part.x, mySnake.y - part.y);
        
        // Nếu đầu mình chạm thân địch -> CHẾT
        if (dist < 15) {
           die();
           return; 
        }
      }
    }
  }

  function die() {
    isPlaying = false;
    
    // Gửi tin nhắn chết kèm tọa độ xác để biến thành thịt
    socket.send(JSON.stringify({
      type: "dead",
      body: mySnake.body // Gửi toàn bộ xác lên server
    }));

    document.getElementById('finalScore').innerText = mySnake.score;
    document.getElementById('deathPanel').style.display = 'block';
  }

  function sendUpdate() {
    if(socket.readyState === WebSocket.OPEN) {
      socket.send(JSON.stringify({
        type: "move",
        info: {
          id: myId,
          x: Math.round(mySnake.x),
          y: Math.round(mySnake.y),
          body: mySnake.body.filter((_,i)=>i%3===0), // Gửi ít đốt để giảm lag
          score: mySnake.score,
          skin: mySnake.skin,
          name: mySnake.name
        }
      }));
    }
  }

  /* --- RENDER --- */
  function render() {
    ctx.fillStyle = '#050505';
    ctx.fillRect(0,0,canvas.width, canvas.height);

    ctx.save();
    ctx.translate(-camera.x, -camera.y);

    // Vẽ Grid
    drawGrid();

    // Vẽ Food
    for (let fid in foods) {
      const f = foods[fid];
      ctx.shadowBlur = 15;
      ctx.shadowColor = f.type === 'flesh' ? '#ffaa00' : '#fff';
      
      if (f.type === 'flesh') {
        // Vẽ thịt (sáng hơn)
        ctx.fillStyle = '#ffaa00';
        ctx.beginPath(); ctx.arc(f.x, f.y, 8, 0, Math.PI*2); ctx.fill();
      } else {
        // Vẽ hoa quả
        ctx.font = "24px Arial";
        ctx.textAlign = "center"; ctx.textBaseline = "middle";
        ctx.fillText(f.icon, f.x, f.y);
      }
      ctx.shadowBlur = 0;
    }

    // Vẽ Địch
    for (let pid in others) {
      if (others[pid].id === myId) continue;
      drawSnake(others[pid]);
    }

    // Vẽ Mình
    drawSnake(mySnake);

    ctx.restore();
  }

  function drawSnake(s) {
    if (!s.body) return;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    
    // Thân
    ctx.lineWidth = 22;
    ctx.strokeStyle = s.skin || '#fff';
    ctx.shadowBlur = 10; ctx.shadowColor = s.skin;
    
    ctx.beginPath();
    if(s.body.length) ctx.moveTo(s.body[0].x, s.body[0].y);
    for(let i=1; i<s.body.length; i++) ctx.lineTo(s.body[i].x, s.body[i].y);
    ctx.stroke();

    // Đầu
    ctx.fillStyle = '#fff';
    ctx.beginPath(); ctx.arc(s.x, s.y, 12, 0, Math.PI*2); ctx.fill();
    
    // Tên
    ctx.fillStyle = 'white'; ctx.shadowBlur=0;
    ctx.font = "bold 14px Arial"; ctx.textAlign="center";
    ctx.fillText(s.name, s.x, s.y - 20);
  }

  function drawGrid() {
    ctx.strokeStyle = '#222'; ctx.lineWidth = 2;
    ctx.strokeRect(0,0,CONFIG.worldSize, CONFIG.worldSize); // Biên giới
    
    // Vẽ lưới
    const gridSize = 100;
    // Tính toán vùng nhìn thấy để vẽ cho nhẹ
    const startX = Math.floor(camera.x/gridSize)*gridSize;
    const startY = Math.floor(camera.y/gridSize)*gridSize;
    
    ctx.beginPath();
    for(let x=startX; x<camera.x+window.innerWidth; x+=gridSize) {
      if(x>0 && x<CONFIG.worldSize) { ctx.moveTo(x, Math.max(0,camera.y)); ctx.lineTo(x, Math.min(CONFIG.worldSize, camera.y+window.innerHeight)); }
    }
    for(let y=startY; y<camera.y+window.innerHeight; y+=gridSize) {
      if(y>0 && y<CONFIG.worldSize) { ctx.moveTo(Math.max(0,camera.x), y); ctx.lineTo(Math.min(CONFIG.worldSize, camera.x+window.innerWidth), y); }
    }
    ctx.stroke();
  }
</script>
</body>
</html>
